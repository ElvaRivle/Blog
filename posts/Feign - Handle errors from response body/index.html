<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feign - Handle errors from response body</title>
    <meta name="description" content="Configuring Feign decoder and error decoder to parse response body from 200 and non-200 response codes">
    <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADyUlEQVR4nO3YsY1TURRF0Wf0m6GJETENkBA5cBsIcmIkC5kySAgQRVADIkITESBMDya4/rPXquBEW+++wwq7Hk8v1loP0zuYdbic301vmLJNDxj2sNZ6Oz2CcdkAPJseAMwRAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAgTAAjbpgdwk8e11t/pEeyfAOzT87XWj+kR7J8A7NOfw+XsBcB/8wcAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYQIAYdv0AG7y6Xo8/Z4ecQc+HC7nL9Mj9kwA9unl9IA78Xl6wN45ASBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBsmx7ATV6ttX5Nj7gD36cH7J0A7NPXw+X8c3oE++cEgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgDABgLBtegA3eX09nh6nRzwVh8v54/SGKQKwT++nBzwx2QA4ASBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBMACBsmx4w7Nta6830CJjyDyQhIMoCavVzAAAAAElFTkSuQmCC" />
    <link rel="stylesheet" href="/Blog/css/styles.css">
    <link rel="alternate" href="/Blog/feed/feed.xml" type="application/atom+xml" title="Elvir&#39;s Blog">
    <link rel="alternate" href="/Blog/feed/feed.json" type="application/json" title="Elvir&#39;s Blog">
    <link
			href="https://unpkg.com/prismjs@1.29.0/themes/prism-okaidia.css"
			rel="stylesheet"
		/>
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Elvir&#39;s Blog">
    <meta property="og:url" content="https://elvarivle.github.com/Blogposts/Feign - Handle errors from response body/">
    <meta property="og:title" content="Feign - Handle errors from response body">
    <meta property="og:description" content="Configuring Feign decoder and error decoder to parse response body from 200 and non-200 response codes">

    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://elvarivle.github.com/Blogposts/Feign - Handle errors from response body/">
    <meta property="twitter:title" content="Feign - Handle errors from response body">
    <meta property="twitter:description" content="Configuring Feign decoder and error decoder to parse response body from 200 and non-200 response codes">
  </head>
  <body>
    <header>
        <span class=""><a href="/Blog/">home</a> - </span>
        <span class=""><a href="/Blog/posts">posts</a> - </span>
        <span class=""><a href="/Blog/about">about</a> - </span>
        <span class=""><a href="/Blog/feed/feed.xml">rss</a> - </span>
        <span class=""><a href="/Blog/search">search</a></span>

    </header>

    <main class="tmpl-post">
      <h1 class="title">Feign - Handle errors from response body</h1>
<div class="subtitle">
<time class="post" datetime="30 Jun 2024">30 Jun 2024</time>
<a class="tag" href="/Blog/tags/feign/" >feign</a>
<a class="tag" href="/Blog/tags/error-handling/" >error handling</a>
<a class="tag" href="/Blog/tags/feign-decoder/" >feign decoder</a>
<a class="tag" href="/Blog/tags/feign-error-decoder/" >feign error decoder</a>
</div>
<h1 id="devil-is-in-the-details" tabindex="-1">Devil is in the details <a class="direct-link" href="#devil-is-in-the-details" aria-hidden="true">#</a></h1>
<p>It's time for you to grab the next ticket in the sprint. The ticket says:</p>
<blockquote>
<p>Configure error handling for XZY third-party API in our codebase</p>
</blockquote>
<p><em>&quot;I know how to write an error decoder, this will be easy&quot;</em>, you may say. You go to the XYZ documentation website and see that you need to handle about 10 possible errors. Along with that, you're greeted with a surprise: <strong>In the case of error, all methods return the error details in the body, but some methods return 200, and some non-200 status codes</strong>. Issue here is that error decoder, which handles non-200 status codes, and regular decoder, which handles 200 status codes, perform error handling quite differently. This blog post should provide a solution on how to avoid code duplication (keep error handling logic in one place), and also catch only one exception, <code>FeignException</code>, in the service layer (and not 10 that are listed on the documentation website), all while still using both decoders.</p>
<h1 id="how-decoding-error-handling-works-under-the-hood" tabindex="-1">How decoding error handling works under the hood <a class="direct-link" href="#how-decoding-error-handling-works-under-the-hood" aria-hidden="true">#</a></h1>
<p>Let's take a look at <a href="https://github.com/OpenFeign/feign/blob/master/core/src/main/java/feign/InvocationContext.java" target="_blank">InvocationContext.java</a> from Feign library, where calls to both decoders are implemented, to see how they perform error handling.</p>
<p>Regular decoder call source code:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">,</span> <span class="token class-name">Type</span> returnType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> returnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">FeignException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DecodeException</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">errorReading</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>Error decoder call source code:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Exception</span> <span class="token function">decodeError</span><span class="token punctuation">(</span><span class="token class-name">String</span> methodKey<span class="token punctuation">,</span> <span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> errorDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>methodKey<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">ensureClosed</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre>
<p>As we can see, regular decoder error handling catches all exceptions, wraps them into <code>FeignException</code> and rethrows that, which is great, since on the service level, we can just catch this <code>FeignException</code>. But error decoder error handling is quite different, it <strong>returns raw</strong> exception, no wrapping, no re-throwing. So in the case you create custom exceptions for all 10 possible API errors, or even if you create one single exception for all cases, and throw them/it from the error decoder, then you will have to handle both those/that error together with <code>FeignException</code> in service layer, which isn't ideal.</p>
<p>So, let's see the solution where all error handling logic is unified and service layer only deals with the <code>FeignException</code>, nothing else.</p>
<h1 id="solution-theory" tabindex="-1">Solution (theory) <a class="direct-link" href="#solution-theory" aria-hidden="true">#</a></h1>
<p><em>Just to be clear, I'm not saying this is the only or the best solution, but the one I've come to with the best intention.</em></p>
<p>The solution consist of the following:</p>
<ol>
<li>Create one base exception <code>BaseXYZApiException</code> that accepts either message as <code>String</code>, or cause as <code>Throwable</code>
<ul>
<li>If you decide to use cause as <code>Throwable</code>, create custom exceptions for each of the 10 API error cases</li>
</ul>
</li>
<li>That base exception should extend <code>FeignException</code></li>
<li>From regular decoder throw <code>BaseXYZApiException</code>, passing it either some custom message, or one of the 10 custom exceptions as cause</li>
<li>From error decoder, call regular decoder by wrapping it in <code>try-catch</code> block</li>
<li>If <code>catch</code> block catches <code>BaseXYZApiException</code>, return it from error decoder. Otherwise, call <a href="https://github.com/OpenFeign/feign/blob/master/core/src/main/java/feign/codec/ErrorDecoder.java#L102" target="_blank">default error decoder</a> provided by Feign</li>
<li>Only catch <code>FeignException</code> in service layer, not minding <code>BaseXYZApiException</code> or any of the 10 exceptions</li>
<li>Configure Feign client appropriately</li>
</ol>
<h1 id="we-covered-all-possible-scenarios" tabindex="-1">We covered all possible scenarios <a class="direct-link" href="#we-covered-all-possible-scenarios" aria-hidden="true">#</a></h1>
<p>Let's examine all possible cases which can happen and how we covered them with the provided solution:</p>
<ol>
<li>200 response code without error in the body → regular decoder will be called and no exception will be thrown, our service layer will receive decoded response object, the happiest path possible</li>
</ol>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        ...
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>
<ol start="2">
<li>200 response code with error in the body → regular decoder will be called and our custom made exception will be thrown (<code>BaseXYZApiException</code> mentioned earlier), which will be handled by our service layer as <code>FeignException</code></li>
</ol>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"_comment"</span><span class="token operator">:</span> <span class="token string">"HTTP respone code for this body is 200"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        ...
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">301</span><span class="token punctuation">,</span>
        <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Error message"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ol start="3">
<li>non-200 response code with or without error in the body → error decoder will be called
<ol>
<li>First handle all response codes where error wouldn't be in the body per XYZ API docs. Example in our case can be 429, Too Many Requests, where body is completely empty</li>
<li>If response code is one where error could be in the body per XYZ API docs, call the regular decoder to extract proper exception from it, then return that exception</li>
<li>If regular decoder from the previous step doesn't throw <code>BaseXYZApiException</code>, then some other error has happened which we will leave to default Feign error decoder to handle</li>
<li>Any exception returned from the error decoder will be handled by our service layer as <code>FeignException</code></li>
</ol>
</li>
</ol>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"_comment"</span><span class="token operator">:</span> <span class="token string">"HTTP respone code for this body is non-200"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        ...
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">301</span><span class="token punctuation">,</span>
        <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Error message"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h1 id="solution-code-kotlin-example" tabindex="-1">Solution (code, Kotlin example) <a class="direct-link" href="#solution-code-kotlin-example" aria-hidden="true">#</a></h1>
<ol>
<li>Create one base exception <code>BaseXYZApiException</code> that accepts either message as <code>String</code>, or cause as <code>Throwable</code>
<ul>
<li>If you decide to use cause as <code>Throwable</code>, create custom exceptions for each of the 10 API error cases</li>
</ul>
</li>
<li>That base exception should extend <code>FeignException</code></li>
</ol>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">//example for one of the 10 possible exceptions for API error</span>
<span class="token keyword">class</span> InvalidApiKeyException <span class="token operator">:</span>
    <span class="token function">RuntimeException</span><span class="token punctuation">(</span>
        <span class="token string-literal singleline"><span class="token string">"Invalid API key for XZY external API"</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token comment">//this example will use cause as Throwable</span>
<span class="token keyword">class</span> <span class="token function">BaseXYZApiException</span><span class="token punctuation">(</span>
    status<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    cause<span class="token operator">:</span> Throwable<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FeignException</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> cause<span class="token punctuation">.</span>message<span class="token punctuation">,</span> cause<span class="token punctuation">)</span></code></pre>
<ol start="3">
<li>From regular decoder throw <code>BaseXYZApiException</code>, passing it either some custom message, or one of the 10 custom exceptions as cause</li>
</ol>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> INVALID_API_KEY <span class="token operator">=</span> <span class="token number">301</span>
<span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> EXPIRED_SUBSCRIPTION <span class="token operator">=</span> <span class="token number">302</span>
<span class="token operator">..</span><span class="token punctuation">.</span>

<span class="token keyword">class</span> <span class="token function">ResponseDecoder</span><span class="token punctuation">(</span>objectMapper<span class="token operator">:</span> ObjectMapper<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">JacksonDecoder</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">,</span> type<span class="token operator">:</span> Type<span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{</span>
        <span class="token keyword">val</span> decodedResponse <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> type<span class="token punctuation">)</span>
		<span class="token keyword">val</span> error <span class="token operator">=</span> decodedResponse<span class="token punctuation">.</span>error

        <span class="token comment">//error object contains code attribute</span>
        <span class="token comment">//based on which we determine which exception should be thrown</span>
        <span class="token keyword">val</span> baseException <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>error<span class="token operator">?</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            INVALID_API_KEY <span class="token operator">-></span> <span class="token function">InvalidApiKeyException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            EXPIRED_SUBSCRIPTION <span class="token operator">-></span> <span class="token function">ExpiredSubscriptionException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>baseException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token comment">//passing baseException defined above to BaseXYZApiException</span>
            <span class="token keyword">throw</span> <span class="token function">BaseXYZApiException</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baseException<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//no error found in response, the happiest path</span>
        <span class="token keyword">return</span> decodedResponse
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ol start="4">
<li>From error decoder, call regular decoder by wrapping it in <code>try-catch</code> block</li>
<li>If <code>catch</code> block catches <code>BaseXYZApiException</code>, return it from error decoder. Otherwise, call <a href="https://github.com/OpenFeign/feign/blob/master/core/src/main/java/feign/codec/ErrorDecoder.java#L102" target="_blank">default error decoder</a> provided by Feign</li>
</ol>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">ResponseErrorDecoder</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> regularDecoder<span class="token operator">:</span> ResponseDecoder<span class="token punctuation">)</span> <span class="token operator">:</span> ErrorDecoder <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> statusCodesWhereBodyCouldContainError <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>INTERNAL_SERVER_ERROR_500<span class="token punctuation">,</span> FORBIDDEN_403<span class="token punctuation">,</span> BAD_REQUEST_400<span class="token punctuation">)</span>

    <span class="token comment">//create default error decoder provided by Feign</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> defaultErrorDecoder <span class="token operator">=</span> ErrorDecoder<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">decode</span><span class="token punctuation">(</span>methodKey<span class="token operator">:</span> String<span class="token punctuation">,</span> response<span class="token operator">:</span> Response<span class="token punctuation">)</span><span class="token operator">:</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">val</span> status <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//first handle all response codes where body wouldn't contain an error</span>
            TOO_MANY_REQUESTS_429 <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token function">RetryableException</span><span class="token punctuation">(</span>
                    response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    response<span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">httpMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span> <span class="token keyword">as</span> Long<span class="token operator">?</span><span class="token punctuation">,</span>
                    response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token comment">//if regular decoder doesn't return BaseXYZApiException</span>
                <span class="token comment">//fallback to default error decoder</span>
                <span class="token function">getExceptionFromBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
                    <span class="token operator">?:</span> defaultErrorDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>methodKey<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getExceptionFromBody</span><span class="token punctuation">(</span>response<span class="token operator">:</span> Response<span class="token punctuation">)</span><span class="token operator">:</span> Exception<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment">//response code for which parsing the body isn't necessary</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token keyword">in</span> statusCodesWhereBodyCouldContainError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>
            regularDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> ResponseType2<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
            <span class="token comment">//no error in body found</span>
            <span class="token keyword">null</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token operator">:</span> BaseXYZApiException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token comment">//body contains error and regular decoder threw BaseXYZApiException</span>
            ex
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token comment">//we can ignore exceptions that aren't BaseXYZApiException</span>
	        <span class="token comment">//Feign default error decoder will handle them properly</span>
            <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ol start="6">
<li>Only catch <code>FeignException</code> in service layer, not minding <code>BaseXYZApiException</code> or any of the 10 exceptions</li>
</ol>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> clientCallResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xyzClient<span class="token punctuation">.</span><span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//the happiest path</span>
  <span class="token comment">//do something with the proper response here</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token operator">:</span> FeignException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//we don't lose information about what has caused FeignException since we provided the cause to the BaseXYZApiException</span>
  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">"XYZ API call failed"</span></span> <span class="token punctuation">}</span>
  <span class="token keyword">throw</span> <span class="token function">SomeNiceClientFacingError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<ol start="7">
<li>Configure Feign client appropriately</li>
</ol>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> XYZClient <span class="token punctuation">{</span>
    <span class="token keyword">val</span> regularDecoder <span class="token operator">=</span> <span class="token function">ResponseDecoder</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Feign
        <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>regularDecoder<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">errorDecoder</span><span class="token punctuation">(</span><span class="token function">ResponseErrorDecoder</span><span class="token punctuation">(</span>regularDecoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retryer</span><span class="token punctuation">(</span><span class="token function">XYZApiRetryer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>


    </main>
  </body>
</html>
